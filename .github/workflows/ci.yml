name: CloudGate CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Authorize Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Verify GCP Authentication
        run: |
          echo "ğŸ“‹ Current GCP Project:"
          gcloud config get-value project
          echo "ğŸ“‹ Current GCP Account:"
          gcloud config get-value account

      # Frontend Pre-checks
      - name: ğŸ” Frontend Pre-deployment Checks
        run: |
          echo "ğŸ” Running frontend pre-deployment checks..."
          cd frontend
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "ğŸ” Running TypeScript check..."
          npm run typecheck
          echo "âœ… Frontend checks passed!"

      # Backend Pre-checks
      - name: ğŸ” Backend Pre-deployment Checks
        run: |
          echo "ğŸ” Running backend pre-deployment checks..."
          cd backend
          echo "ğŸ“¦ Verifying Go modules..."
          go mod verify
          echo "ğŸ” Running Go vet..."
          go vet ./...
          echo "ğŸ”§ Running Go fmt..."
          go fmt ./...
          echo "ğŸ—ï¸ Running Go build..."
          go build ./...
          echo "âœ… Backend checks passed!"

      # Deploy Backend
      - name: ğŸš€ Deploy Backend to Cloud Run
        run: |
          echo "ğŸš€ Starting backend deployment..."
          echo "ğŸ“ Deploying to: us-central1"
          echo "ğŸ·ï¸ Service: cloudgate-backend"

          gcloud run deploy cloudgate-backend \
            --source ./backend \
            --region us-central1 \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --max-instances=10 \
            --timeout=300 \
            --set-env-vars="NEON_DATABASE_URL=${{ secrets.NEON_DATABASE_URL }},KEYCLOAK_URL=${{ secrets.KEYCLOAK_URL }},KEYCLOAK_REALM=${{ secrets.KEYCLOAK_REALM }},KEYCLOAK_CLIENT_ID=${{ secrets.KEYCLOAK_CLIENT_ID }},ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }},GIN_MODE=release" \
            --execution-environment=gen2 \
            --verbosity=debug

          echo "âœ… Backend deployment completed!"

      - name: ğŸ” Verify Backend Deployment
        run: |
          echo "ğŸ” Verifying backend deployment..."
          BACKEND_URL=$(gcloud run services describe cloudgate-backend --region=us-central1 --format='value(status.url)')
          echo "ğŸŒ Backend URL: $BACKEND_URL"

          echo "ğŸ¥ Checking backend health..."
          curl -f "$BACKEND_URL/health" || echo "âš ï¸ Health check failed, but deployment may still be successful"

      # Deploy Frontend
      - name: ğŸš€ Deploy Frontend to Cloud Run
        run: |
          echo "ğŸš€ Starting frontend deployment..."
          echo "ğŸ“ Deploying to: us-central1"
          echo "ğŸ·ï¸ Service: cloudgate-frontend"

          gcloud run deploy cloudgate-frontend \
            --source ./frontend \
            --region us-central1 \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --max-instances=10 \
            --timeout=300 \
            --execution-environment=gen2 \
            --verbosity=debug

          echo "âœ… Frontend deployment completed!"

      - name: ğŸ” Verify Frontend Deployment
        run: |
          echo "ğŸ” Verifying frontend deployment..."
          FRONTEND_URL=$(gcloud run services describe cloudgate-frontend --region=us-central1 --format='value(status.url)')
          echo "ğŸŒ Frontend URL: $FRONTEND_URL"

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "ğŸ‰ Deployment Summary:"
          echo "===================="

          BACKEND_URL=$(gcloud run services describe cloudgate-backend --region=us-central1 --format='value(status.url)' 2>/dev/null || echo "âŒ Backend deployment failed")
          FRONTEND_URL=$(gcloud run services describe cloudgate-frontend --region=us-central1 --format='value(status.url)' 2>/dev/null || echo "âŒ Frontend deployment failed")

          echo "ğŸ–¥ï¸  Backend:  $BACKEND_URL"
          echo "ğŸŒ Frontend: $FRONTEND_URL"
          echo "===================="

      # Error Handling - Get Build Logs on Failure
      - name: ğŸ“‹ Get Build Logs on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Getting recent build logs..."
          echo "ğŸ“‹ Recent builds:"
          gcloud builds list --limit=3 --region=us-central1 --format="table(id,status,createTime)"

          echo "ğŸ“‹ Getting logs for the most recent failed build..."
          FAILED_BUILD=$(gcloud builds list --limit=1 --filter="status=FAILURE" --region=us-central1 --format="value(id)")
          if [ -n "$FAILED_BUILD" ]; then
            echo "ğŸ” Build ID: $FAILED_BUILD"
            echo "ğŸ“‹ Build logs:"
            gcloud builds log "$FAILED_BUILD" --region=us-central1
          else
            echo "âš ï¸ No recent failed builds found"
          fi
